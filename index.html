<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ghi nh·ªõ h√¨nh ·∫£nh tr√°i c√¢y c√πng AI</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            text-align: center;
            background: linear-gradient(135deg, #CCFFAA 0%, #1E5B53 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        body::before {
            content: "";
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            background-image: url('https://i.pinimg.com/originals/36/a1/87/36a1874f7c7f3aaadb4284ea22a69264.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            filter: blur(5px);
            opacity: 0.5;
            mix-blend-mode: overlay;
            z-index: -1;
        }

        #game-area {
            max-width: 1400px;
            /* TƒÉng chi·ªÅu r·ªông */
            width: 100%;
            background: #fefce8;
            border-radius: 40px;
            /* L√†m bo g√≥c l·ªõn h∆°n */
            box-shadow: 0 12px 48px rgba(0, 0, 0, 0.2);
            /* TƒÉng shadow */
            transition: filter 0.3s ease;
            position: relative;
            /* ƒê·ªÉ pseudo-element ƒë·ªãnh v·ªã ƒë√∫ng */
            padding: 20px;
            /* Th√™m padding ƒë·ªÉ vi·ªÅn kh√¥ng s√°t n·ªôi dung */
        }

        #game-area::before {
            content: '';
            position: absolute;
            top: -12px;
            /* ƒê·ªô d√†y vi·ªÅn */
            left: -12px;
            right: -12px;
            bottom: -12px;
            background: linear-gradient(135deg, #4ade80, #22c55e, #3b82f6, #ef4444);
            /* Gradient vi·ªÅn */
            border-radius: 52px;
            /* Bo g√≥c l·ªõn h∆°n ƒë·ªÉ bao quanh border */
            z-index: -1;
            /* ƒê·∫∑t sau game-area */
        }

        body.modal-open #game-area {
            filter: blur(5px);
        }


        /* B·ªè header hi·ªán t·∫°i, k·∫øt qu·∫£ s·∫Ω ƒë∆∞a l√™n top khi c·∫ßn */

        .board {
            display: flex;
            /* Thay ƒë·ªïi th√†nh flex ƒë·ªÉ s·∫Øp x·∫øp tr√™n 1 h√†ng ngang */
            flex-direction: row;
            justify-content: center;
            gap: 16px;
            /* TƒÉng gap */
            flex-wrap: nowrap;
            overflow-x: hidden;
            /* B·ªè scrollbar */
            margin: 20px 0;
            padding: 16px;
            border-radius: 16px;
            background: #f8fafc;
            box-shadow: inset 0 4px 8px rgba(0, 0, 0, 0.05);
        }

        #player-board {
            background: #e6fffa;
            /* M√†u kh√°c bi·ªát cho ng∆∞·ªùi ch∆°i */
        }

        #image-sequence {
            display: flex;
            flex-direction: row;
            justify-content: center;
            gap: 16px;
            flex-wrap: nowrap;
            overflow-x: hidden;
            margin: 20px 0;
            padding: 16px;
            border-radius: 16px;
            background: #f8fafc;
            box-shadow: inset 0 4px 8px rgba(0, 0, 0, 0.05);
        }

        .image-box {
            width: 70px;
            /* TƒÉng k√≠ch th∆∞·ªõc h√¨nh ·∫£nh */
            height: 70px;
            border: 4px solid #d1d5db;
            border-radius: 20px;
            font-size: 35px;
            display: flex;
            justify-content: center;
            align-items: center;
            background: white;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
            cursor: grab;
            position: relative;
            flex-shrink: 1;
            min-width: 0;
            transition: transform 1s ease;
            /* TH√äM: Transition m∆∞·ª£t cho di chuy·ªÉn swap */
        }

        .image-box:active {
            cursor: grabbing;
        }

        .image-box:hover {
            transform: translateY(-5px) scale(1.08);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.2);
        }

        #ai-board .image-box {
            border: 4px solid #9ca3af;
            background: #f1f5f9;
            cursor: default;
        }

        #ai-board .image-box:hover {
            transform: none;
            scale: 1;
        }

        .label {
            font-weight: 700;
            margin: 25px 0 10px;
            color: #1e293b;
            font-size: clamp(1em, 3vw, 1.4em);
            padding: 8px 16px;
            /* TH√äM: Padding cho khung */
            border-radius: 8px;
            /* TH√äM: Bo g√≥c khung */
            background-color: #ffd700;
            /* TH√äM: M√†u v√†ng ban ƒë·∫ßu cho t·∫•t c·∫£ label */
            transition: background-color 0.3s ease;
            /* TH√äM: Transition cho m√†u */
        }

        .label.arranging {
            background-color: #ffd700;
            /* V√†ng cho tr·∫°ng th√°i ƒëang s·∫Øp x·∫øp */
        }

        .label.arranged {
            background-color: #22c55e;
            /* Xanh l√° cho tr·∫°ng th√°i ƒë√£ s·∫Øp x·∫øp */
        }

        #status {
            font-weight: 600;
            color: #1e293b;
            /* margin: 25px 0; */
            font-size: clamp(1.8em, 5vw, 3em);
            /* TƒÇNG: TƒÉng min v√† max cho ch·ªØ l·ªõn h∆°n tr√™n laptop */
            /* padding: 20px; */
            border-radius: 16px;
            transition: opacity 0.5s ease, transform 0.5s ease;
            color: #ffd700;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.5);
            animation: glow 2s ease-in-out infinite alternate;
            margin: 20px 0;

        }

        /* #status.highlight {
            font-size: 2.5em;
            color: #ffd700;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.5);
            animation: glow 2s ease-in-out infinite alternate;
            margin: 20px 0;
        } */

        /* Countdown styles */
        /* Khi ƒëang countdown - l√†m m·ªù to√†n n·ªÅn v√† n·ªïi countdown */
        body.countdown #game-area {
            display: none;
            pointer-events: none;
            /* Kh√≥a t∆∞∆°ng t√°c */
        }

        body.countdown::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            z-index: 998;
        }

        body.countdown #status {
            position: fixed !important;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: clamp(2em, 10vw, 4em);
            /* S·ª¨A: Responsive t·ªët h∆°n, gi·∫£m max size */
            font-weight: bold;
            color: #fff;
            text-shadow: 0 0 25px rgba(0, 0, 0, 0.8);
            z-index: 999;
            background: transparent !important;
            padding: 0 !important;
            border-radius: 0 !important;
            border: none !important;
            margin: 0 !important;
            opacity: 1;
            transition: opacity 0.5s ease;
            word-break: break-word;
            /* S·ª¨A: Cho ph√©p wrap ch·ªØ ƒë·ªÉ kh√¥ng tr√†n vi·ªÅn */
        }

        body.countdown #status.loading::after {
            content: '.';
            animation: loading-dots 1.5s infinite;
        }

        @keyframes loading-dots {
            0% {
                content: '.';
            }

            33% {
                content: '..';
            }

            66% {
                content: '...';
            }
        }

        /* Prepare styles - l√†m m·ªù background ƒë·ªÉ t·∫≠p trung chu·∫©n b·ªã */
        body.prepare::before {
            filter: blur(10px);
            opacity: 0.8;
        }

        body.prepare:after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            z-index: 998;
        }

        body.prepare #status {
            position: fixed !important;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: clamp(3em, 12vw, 6em);
            /* TƒÇNG: TƒÉng max size ƒë·ªÉ l·ªõn h∆°n tr√™n laptop */
            font-weight: bold;
            color: #fff;
            text-shadow: 0 0 25px rgba(0, 0, 0, 0.8);
            z-index: 999;
            background: transparent !important;
            padding: 0 !important;
            border-radius: 0 !important;
            border: none !important;
            margin: 0 !important;
            opacity: 1;
            transition: opacity 0.5s ease;
            word-break: break-word;
            /* S·ª¨A: Cho ph√©p wrap ch·ªØ ƒë·ªÉ kh√¥ng tr√†n vi·ªÅn */
        }

        body.prepare #game-area {
            display: none;
            pointer-events: none;
        }

        button {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            cursor: pointer;
            margin: 10px;
            font-size: clamp(0.9em, 3vw, 1.2em);
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
        }

        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 24px rgba(59, 130, 246, 0.5);
        }

        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }

        #difficulty-selection {
            margin: 25px auto;
            padding: 25px;
            background: #fefce8;
            border-radius: 20px;
            box-shadow: 0 6px 24px rgba(0, 0, 0, 0.15);
        }

        #difficulty-selection h2 {
            font-size: clamp(1.5em, 4vw, 2em);
            color: #1f2937;
            margin-bottom: 20px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }

        .gamepad-icon {
            font-size: 1.5em;
            color: #7c3aed;
        }

        .difficulty-btn {
            border: none;
            color: white;
            border-radius: 15px;
            padding: 15px 25px;
            margin: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: clamp(1em, 3vw, 1.3em);
            font-weight: 700;
        }

        .difficulty-btn[data-level="easy"] {
            background: #22c55e;
            box-shadow: 0 6px 16px rgba(34, 197, 94, 0.4);
        }

        .difficulty-btn[data-level="easy"]:hover {
            background: #16a34a;
            transform: scale(1.08);
            box-shadow: 0 8px 24px rgba(34, 197, 94, 0.5);
        }

        .difficulty-btn[data-level="medium"] {
            background: #3b82f6;
            box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
        }

        .difficulty-btn[data-level="medium"]:hover {
            background: #2563eb;
            transform: scale(1.08);
            box-shadow: 0 8px 24px rgba(59, 130, 246, 0.5);
        }

        .difficulty-btn[data-level="hard"] {
            background: #ef4444;
            box-shadow: 0 6px 16px rgba(239, 68, 68, 0.4);
        }

        .difficulty-btn[data-level="hard"]:hover {
            background: #dc2626;
            transform: scale(1.08);
            box-shadow: 0 8px 24px rgba(239, 68, 68, 0.5);
        }

        #result {
            margin-top: 0;
            padding: 25px;
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border-radius: 20px 20px 0 0;
            box-shadow: 0 6px 24px rgba(0, 0, 0, 0.15);
        }

        #result h3 {
            margin: 0 0 20px;
            color: #92400e;
            font-size: clamp(1.4em, 3vw, 1.8em);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .stat-box {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .stat-number {
            font-size: clamp(2em, 5vw, 2.5em);
            font-weight: 700;
            margin: 0;
        }

        .highlight-correct {
            border-color: #22c55e !important;
            background: linear-gradient(135deg, #dcfce7, #bbf7d0) !important;
            box-shadow: 0 0 25px #22c55e50 !important;
            animation: correctPulse 0.6s ease;
        }

        .highlight-wrong {
            border-color: #ef4444 !important;
            background: linear-gradient(135deg, #fee2e2, #fecaca) !important;
            box-shadow: 0 0 25px #ef444450 !important;
            animation: wrongShake 0.6s ease;
        }

        .highlight-swap {
            border-color: #ffd700 !important;
            background: linear-gradient(135deg, #fffbeb, #fef08a) !important;
            box-shadow: 0 0 25px #ffd70050 !important;
            animation: none;
            /* THAY ƒê·ªîI: B·ªè animation c≈© ƒë·ªÉ t·∫≠p trung v√†o transition di chuy·ªÉn */
        }

        @keyframes correctPulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }
        }

        @keyframes wrongShake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-5px);
            }

            75% {
                transform: translateX(5px);
            }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 25px;
            width: 700px;
            max-width: 95vw;
            text-align: center;
            animation: popIn 0.5s ease-out;
        }

        @keyframes popIn {
            from {
                transform: translate(-50%, -50%) scale(0.5);
                opacity: 0;
            }

            to {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
        }

        @media (max-width: 768px) {
            .play-areas {
                flex-direction: column;
            }

            .image-box {
                width: 55px;
                height: 55px;
                font-size: 28px;
            }

            .board {
                gap: 10px;
                justify-content: space-between;
                overflow-x: hidden;
            }

            #image-sequence {
                justify-content: flex-start;
                gap: 10px;
                padding: 10px;
                overflow-x: hidden;
            }

            .modal-content {
                width: 95vw;
            }

            #game-title {
                font-size: 2.5em;
            }

            #status {
                font-size: 2em;
            }

            .label {
                font-size: 1.2em;
            }

            button {
                font-size: 1em;
            }

            #difficulty-selection h2 {
                font-size: 1.8em;
            }

            .difficulty-btn {
                font-size: 1.1em;
            }

            .menu-desc {
                font-size: 0.9em;
            }
        }

        @media (max-width: 480px) {
            .image-box {
                width: 40px;
                height: 40px;
                font-size: 22px;
            }

            .board,
            #image-sequence {
                gap: 8px;
                padding: 8px;
                justify-content: center;
            }

            #game-title {
                font-size: 2em;
            }

            #status {
                font-size: 1.5em;
            }

            .label {
                font-size: 1em;
            }

            button {
                font-size: 0.9em;
            }

            #difficulty-selection h2 {
                font-size: 1.5em;
            }

            .difficulty-btn {
                font-size: 1em;
            }

            .menu-desc {
                font-size: 0.8em;
            }
        }

        .loading {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Song song player v√† ai */
        .play-areas {
            display: flex;
            justify-content: space-between;
            gap: 25px;
        }

        .play-area {
            flex: 1;
            min-width: 0;
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        #player-area {
            border: 4px solid blue;
        }

        #ai-area {
            border: 4px solid red;
        }

        /* C·∫≠p nh·∫≠t ƒë·ªÉ kho·∫£ng c√°ch b·∫±ng nhau */
        #result .board {
            gap: 16px;
        }

        #game-title {
            color: #e7e247;
            font-size: clamp(2em, 5vw, 3em);
            /* TƒÉng k√≠ch th∆∞·ªõc ti√™u ƒë·ªÅ */
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.5);
            margin: 30px 0 10px 0;
            animation: glow 2s ease-in-out infinite alternate;
        }

        /* üïπÔ∏è ·∫®n ti√™u ƒë·ªÅ khi v√†o ch·∫ø ƒë·ªô ch∆°i */
        body.playing #game-title {
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease;
        }

        @keyframes glow {
            from {
                text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.5);
            }

            to {
                text-shadow: 0 0 20px #454444, 0 0 30px #3f3f3d;
            }
        }

        /* Fireworks styles */
        .fireworks-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            pointer-events: none;
            z-index: -1;
        }

        .particle {
            position: absolute;
            width: 5px;
            height: 5px;
            border-radius: 50%;
            opacity: 1;
            animation: firework-particle 1s ease-out forwards;
        }

        @keyframes firework-particle {
            0% {
                transform: translate(0, 0);
                opacity: 1;
            }

            100% {
                transform: translate(var(--dx), var(--dy));
                opacity: 0;
            }
        }

        /* Icon row styles */
        .icon-row {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .icon-box {
            width: 50px;
            height: 50px;
            border: 3px solid #d1d5db;
            border-radius: 15px;
            font-size: 25px;
            display: flex;
            justify-content: center;
            align-items: center;
            background: white;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            animation: shake 2s infinite ease-in-out;
        }

        .icon-box:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-3px);
            }

            50% {
                transform: translateX(3px);
            }

            75% {
                transform: translateX(-3px);
            }
        }

        .menu-desc {
            font-size: clamp(0.8em, 2.5vw, 1em);
            color: #555;
            margin-bottom: 10px;
        }

        #submit-btn {
            display: block;
            margin: 20px auto;
        }
    </style>
</head>

<body>

    <h1 id="game-title">GHI NH·ªö H√åNH ·∫¢NH TR√ÅI C√ÇY C√ôNG AI</h1>
    <div id="status"></div>
    <div id="game-area">
        <!-- B·ªè header, result s·∫Ω l√†m header khi c·∫ßn -->

        <div id="difficulty-selection">
            <h2><span class="gamepad-icon">üéÆ</span> H√ÉY CH·ªåN ƒê·ªò KH√ì N√ÄO! </h2>
            <div class="menu-desc">Th·ª≠ th√°ch tr√≠ nh·ªõ c·ªßa b·∫°n b·∫±ng c√°ch ghi nh·ªõ v√† s·∫Øp x·∫øp th·ª© t·ª± c√°c h√¨nh ·∫£nh tr√°i c√¢y
                c√πng v·ªõi AI!</div>
            <div class="icon-row">
                <div class="icon-box">üçé</div>
                <div class="icon-box">üçå</div>
                <div class="icon-box">üçá</div>
                <div class="icon-box">üçä</div>
                <div class="icon-box">üçâ</div>
                <div class="icon-box">üß†</div>
                <div class="icon-box">üí°</div>
            </div>
            <button class="difficulty-btn" data-level="easy">D·ªÑ</button>
            <button class="difficulty-btn" data-level="medium">TRUNG B√åNH</button>
            <button class="difficulty-btn" data-level="hard">KH√ì</button>
        </div>


        <div id="image-sequence" style="display:none;"></div>

        <div class="play-areas" style="display:none;" id="play-areas">
            <div id="player-area" class="play-area" style="display:none;">
                <div class="label" id="player-label">üßç‚Äç‚ôÇÔ∏è B·∫°n s·∫Øp x·∫øp:</div> <!-- TH√äM id cho player label -->
                <div id="player-board" class="board"></div>
            </div>

            <div id="ai-area" class="play-area" style="display:none;">
                <div class="label" id="ai-label">ü§ñ AI s·∫Øp x·∫øp: <span class="loading" id="ai-loading"
                        style="display:none;"></span>
                </div>
                <div id="ai-board" class="board"></div>
            </div>
        </div>

        <button id="submit-btn" style="display:none;">X√°c nh·∫≠n ‚úÖ</button>

        <div id="result" style="display:none;"></div> <!-- B·∫Øt ƒë·∫ßu ·∫©n, hi·ªÉn th·ªã khi c√≥ k·∫øt qu·∫£ -->
    </div>

    <div id="achievement-modal" class="modal">
        <div class="modal-content">
            <div class="fireworks-container"></div>
            <h2 id="achievement-title">üéâ Th√†nh t·ª±u!</h2>
            <p id="achievement-desc"></p>
            <button id="modal-button" onclick="closeModal()">Ti·∫øp t·ª•c</button>
        </div>
    </div>

    <script>
        // ‚úÖ H√åNH ·∫¢NH
        const IMAGES = ["üçé", "üçå", "üçá", "üçä", "üçâ", "üçì", "üçí"];
        let gameState = {
            correctOrder: [], playerOrder: [], aiOrder: [],
            aiDifficulty: "medium", round: 1, maxRounds: 1,
            playerScore: 0, aiScore: 0, sequenceSpeed: 1500,
            numImages: 6,
            aiSwapsMin: 1,
            aiSwapsRand: 2,
            aiReady: false
        };

        let achievementsUnlocked = [];
        let fireworksInterval;

        // ‚úÖ ELEMENTS - HO√ÄN CH·ªàNH
        const elements = {
            status: document.getElementById("status"),
            imageSeq: document.getElementById("image-sequence"),
            playerBoard: document.getElementById("player-board"),
            aiBoard: document.getElementById("ai-board"),
            submitBtn: document.getElementById("submit-btn"),
            result: document.getElementById("result"),
            aiLoading: document.getElementById("ai-loading"),
            playerArea: document.getElementById("player-area"),
            aiArea: document.getElementById("ai-area"),
            playAreas: document.getElementById("play-areas"),
            aiLabel: document.getElementById("ai-label"),
            playerLabel: document.getElementById("player-label") // TH√äM: Element cho player label
        };

        // ‚úÖ RESET UI CHO V√ÅN M·ªöI
        function resetForNewRound() {
            elements.result.innerHTML = "";
            elements.result.style.display = "none";
            elements.playerArea.style.display = "none";
            elements.aiArea.style.display = "none";
            elements.playAreas.style.display = "none";
            elements.submitBtn.style.display = "none";
            elements.status.style.display = "block";
            elements.imageSeq.style.display = "none";
            document.querySelectorAll('.highlight-correct, .highlight-wrong').forEach(el => {
                el.classList.remove('highlight-correct', 'highlight-wrong');
            });
            elements.status.classList.remove('highlight');
            document.getElementById("game-title").style.display = "none";
            achievementsUnlocked = []; // Reset achievements for new game if needed
            elements.aiLabel.textContent = "ü§ñ AI s·∫Øp x·∫øp:";
            elements.aiLabel.classList.remove('arranged'); // TH√äM: Reset class
            elements.playerLabel.classList.remove('arranged'); // TH√äM: Reset class
            gameState.aiReady = false;
        }

        document.addEventListener('DOMContentLoaded', () => {
            bindDifficultyButtons();
        });

        function bindDifficultyButtons() {
            document.querySelectorAll(".difficulty-btn").forEach(btn => {
                btn.onclick = () => {
                    gameState.aiDifficulty = btn.dataset.level;
                    if (gameState.aiDifficulty === "easy") {
                        gameState.numImages = 5;
                        gameState.sequenceSpeed = 2000;
                        gameState.aiSwapsMin = 2;
                        gameState.aiSwapsRand = 2; // 2-3
                    } else if (gameState.aiDifficulty === "medium") {
                        gameState.numImages = 6;
                        gameState.sequenceSpeed = 1500;
                        gameState.aiSwapsMin = 1;
                        gameState.aiSwapsRand = 2; // 1-2
                    } else {
                        gameState.numImages = 7;
                        gameState.sequenceSpeed = 1000;
                        gameState.aiSwapsMin = 0;
                        gameState.aiSwapsRand = 2; // 0-1
                    }
                    document.getElementById("difficulty-selection").style.display = "none";
                    startRound();
                };
            });
        }

        // ‚úÖ H√ÄM START ROUND - S·ª¨A L·ªñI LOOP
        function startRound() {
            resetForNewRound();
            elements.status.textContent = `Ghi nh·ªõ ${gameState.numImages} h√¨nh!`;
            gameState.correctOrder = shuffle(IMAGES.slice(0, gameState.numImages));
            elements.imageSeq.style.display = "flex";
            startCountdown(showSequence);
        }

        function startCountdown(callback) {
            document.body.classList.add('countdown');
            const difficultyText = gameState.aiDifficulty === "easy" ? "D·ªÖ" : gameState.aiDifficulty === "medium" ? "Trung B√¨nh" : "Kh√≥";
            const messages = [
                `B·∫°n ƒë√£ ch·ªçn ch·∫ø ƒë·ªô ${difficultyText}`,
                "H√£y chu·∫©n b·ªã nh√©.",
                "4",
                "3",
                "2",
                "1"
            ];
            let index = 0;
            elements.status.style.opacity = 0;
            setTimeout(() => {
                elements.status.textContent = messages[index];
                elements.status.style.opacity = 1;
            }, 100);
            const interval = setInterval(() => {
                index++;
                if (index < messages.length) {
                    elements.status.style.opacity = 0;
                    setTimeout(() => {
                        elements.status.textContent = messages[index];
                        elements.status.style.opacity = 1;
                    }, 500); // Half of interval for fade out/in
                } else {
                    clearInterval(interval);
                    setTimeout(() => {
                        document.body.classList.remove('countdown');
                        elements.status.textContent = `Ghi nh·ªõ ${gameState.numImages} h√¨nh!`;
                        callback();
                    }, 800);
                }
            }, 1000);
        }

        function showSequence() {
            elements.imageSeq.innerHTML = "";
            let i = 0;
            const showNext = () => {
                if (i >= gameState.numImages) {
                    setTimeout(() => {
                        elements.imageSeq.style.display = "none";
                        startArrangePrepare();
                    }, 1500);
                    return;
                }
                const div = createImageBox(gameState.correctOrder[i]);
                elements.imageSeq.appendChild(div);
                i++;
                setTimeout(showNext, gameState.sequenceSpeed);
            };
            showNext();
        }

        function startArrangePrepare() {
            document.body.classList.add('prepare');
            elements.status.textContent = "C√πng s·∫Øp x·∫øp l·∫°i nh√©!";
            elements.status.style.opacity = 1;
            setTimeout(() => {
                document.body.classList.remove('prepare');
                startPlayerPhase();
            }, 3000);
        }

        function startPlayerPhase() {
            elements.playerArea.style.display = "block";
            elements.aiArea.style.display = "block";
            elements.playAreas.style.display = "flex";
            elements.status.textContent = `S·∫Øp x·∫øp ƒë√∫ng th·ª© t·ª±!`;
            elements.status.classList.add('highlight');
            elements.submitBtn.style.display = "inline-block";
            elements.imageSeq.style.display = "none";
            document.getElementById("game-title").style.display = "none";

            const shuffled = shuffle(IMAGES.slice(0, gameState.numImages));
            setupPlayerBoard(shuffled);
            setupAIBoard(shuffled.slice());
            simulateAdvancedAI();
        }

        function setupAIBoard(shuffled) {
            elements.aiBoard.innerHTML = "";
            shuffled.forEach((img) => {
                const div = createImageBox(img);
                elements.aiBoard.appendChild(div);
            });
        }

        function createImageBox(img) {
            const div = document.createElement("div");
            div.className = "image-box";
            div.textContent = img;
            return div;
        }

        function setupPlayerBoard(shuffled) {
            elements.playerBoard.innerHTML = "";
            gameState.playerOrder = shuffled.slice();
            shuffled.forEach((img) => {
                const div = createImageBox(img);
                div.draggable = true;
                div.addEventListener("dragstart", dragStart);
                div.addEventListener("dragend", dragEnd);
                elements.playerBoard.appendChild(div);
            });
            makeDroppable();
        }

        // ‚úÖ DRAG & DROP
        let draggedItem = null;
        function dragStart(e) {
            draggedItem = this;
            setTimeout(() => {
                this.style.opacity = "0.5";
                this.classList.add('highlight-swap');
            }, 0);
        }
        function dragEnd(e) {
            this.style.opacity = "1";
            this.classList.remove('highlight-swap');
        }
        function dragOver(e) { e.preventDefault(); }
        function dropItem(e) {
            e.preventDefault();
            if (this === draggedItem) return;
            const parent = this.parentNode;
            const draggedIndex = Array.from(parent.children).indexOf(draggedItem);
            const dropIndex = Array.from(parent.children).indexOf(this);
            if (draggedIndex < dropIndex) {
                parent.insertBefore(draggedItem, this.nextSibling);
            } else {
                parent.insertBefore(draggedItem, this);
            }
            draggedItem.style.opacity = "1";
            draggedItem.classList.remove('highlight-swap');
            gameState.playerOrder = Array.from(parent.children).map(c => c.textContent);
        }
        function makeDroppable() {
            document.querySelectorAll("#player-board .image-box").forEach(item => {
                item.addEventListener("dragover", dragOver);
                item.addEventListener("drop", dropItem);
            });
        }

        function simulateAdvancedAI() {
            elements.aiLoading.style.display = "inline-block";
            setTimeout(() => {
                elements.aiLoading.style.display = "none";
                gameState.aiOrder = calculateAIOrder();
                gameState.aiReady = false;
                arrangeAI();
            }, getAIDelay());
        }

        function calculateAIOrder() {
            let aiOrder = [...gameState.correctOrder];
            const numSwaps = gameState.aiSwapsMin + Math.floor(Math.random() * gameState.aiSwapsRand);

            for (let s = 0; s < numSwaps; s++) {
                const i1 = Math.floor(Math.random() * gameState.numImages);
                let i2 = Math.floor(Math.random() * gameState.numImages);
                while (i2 === i1) {
                    i2 = Math.floor(Math.random() * gameState.numImages);
                }
                [aiOrder[i1], aiOrder[i2]] = [aiOrder[i2], aiOrder[i1]];
            }

            return aiOrder;
        }

        function arrangeAI() {
            const boardChildren = Array.from(elements.aiBoard.children);
            let delay = 0;
            const swapDelay = 3500; // THAY ƒê·ªîI: Delay gi·ªØa c√°c swap (ms), ƒëi·ªÅu ch·ªânh n·∫øu mu·ªën ch·∫≠m h∆°n ƒë·ªÉ r√µ r√†ng

            elements.aiLabel.classList.add('arranging'); // TH√äM: Set v√†ng khi b·∫Øt ƒë·∫ßu s·∫Øp x·∫øp

            for (let i = 0; i < gameState.numImages; i++) {
                const target = gameState.aiOrder[i];
                let j = i;
                for (; j < gameState.numImages; j++) {
                    if (boardChildren[j].textContent === target) {
                        break;
                    }
                }
                if (j !== i) {
                    setTimeout(() => {
                        boardChildren[i].classList.add('highlight-swap');
                        boardChildren[j].classList.add('highlight-swap');

                        // TH√äM: T√≠nh kho·∫£ng c√°ch ƒë·ªÉ di chuy·ªÉn m∆∞·ª£t (d·ª±a tr√™n v·ªã tr√≠ th·ª±c tr√™n m√†n h√¨nh)
                        const rectI = boardChildren[i].getBoundingClientRect();
                        const rectJ = boardChildren[j].getBoundingClientRect();
                        const dx = rectJ.left - rectI.left;
                        const dy = rectJ.top - rectI.top;

                        // TH√äM: √Åp d·ª•ng transform ƒë·ªÉ hai item "bay" qua v·ªã tr√≠ nhau
                        boardChildren[i].style.transform = `translate(${dx}px, ${dy}px)`;
                        boardChildren[j].style.transform = `translate(${-dx}px, ${-dy}px)`;

                        setTimeout(() => {
                            // TH√äM: Reset transform v√† th·ª±c hi·ªán swap DOM th·ª±c t·∫ø
                            boardChildren[i].style.transition = 'none'; // T·∫Øt transition t·∫°m ƒë·ªÉ reset kh√¥ng animation
                            boardChildren[j].style.transition = 'none';
                            boardChildren[i].style.transform = '';
                            boardChildren[j].style.transform = '';

                            elements.aiBoard.insertBefore(boardChildren[j], boardChildren[i]);
                            const temp = boardChildren[i];
                            boardChildren[i] = boardChildren[j];
                            boardChildren[j] = temp;

                            // TH√äM: B·∫≠t l·∫°i transition v√† remove highlight
                            setTimeout(() => {
                                boardChildren[i].style.transition = 'transform 1s ease';
                                boardChildren[j].style.transition = 'transform 1s ease';
                                boardChildren[i].classList.remove('highlight-swap');
                                boardChildren[j].classList.remove('highlight-swap');
                            }, 100); // Delay nh·ªè ƒë·ªÉ browser apply
                        }, 1500); // THAY ƒê·ªîI: Th·ªùi gian di chuy·ªÉn (ms), tƒÉng n·∫øu mu·ªën ch·∫≠m h∆°n
                    }, delay);
                    delay += swapDelay;
                }
            }

            setTimeout(() => {
                elements.aiLabel.textContent = "ü§ñ AI ƒë√£ s·∫Øp x·∫øp xong:";
                elements.aiLabel.classList.remove('arranging'); // TH√äM: X√≥a v√†ng
                elements.aiLabel.classList.add('arranged'); // TH√äM: Th√™m xanh l√° khi xong
                gameState.aiReady = true;
                // TH√äM: Reset t·∫•t c·∫£ ƒë·ªÉ tr√°nh l·ªói
                Array.from(elements.aiBoard.children).forEach(child => {
                    child.classList.remove('highlight-swap');
                    child.style.transform = '';
                    child.style.transition = 'transform 1s ease';
                });
            }, delay);
        }

        // ‚úÖ H√ÄM getAIDelay - S·ª¨A L·ªñI
        function getAIDelay() {
            if (gameState.aiDifficulty === "easy") return 1000;
            if (gameState.aiDifficulty === "medium") return 1500;
            return 2000;
        }

        // ‚úÖ SUBMIT - S·ª¨A L·ªñI LOOP V√ÅN
        elements.submitBtn.onclick = checkResults;

        function checkResults() {
            if (!gameState.aiReady) {
                alert("AI ƒëang s·∫Øp x·∫øp, vui l√≤ng ch·ªù m·ªôt ch√∫t!");
                return;
            }
            elements.playerLabel.classList.add('arranged'); // TH√äM: ƒê·ªïi m√†u label ng∆∞·ªùi ch∆°i khi b·∫•m x√°c nh·∫≠n
            gameState.playerOrder = Array.from(elements.playerBoard.children).map(c => c.textContent);
            elements.submitBtn.style.display = "none";
            elements.status.style.display = "none";

            let playerRoundScore = 0, aiRoundScore = 0;
            const playerItems = elements.playerBoard.children;
            const aiItems = elements.aiBoard.children;

            for (let i = 0; i < gameState.numImages; i++) {
                if (gameState.playerOrder[i] === gameState.correctOrder[i]) {
                    playerItems[i].classList.add("highlight-correct");
                    playerRoundScore++;
                } else {
                    playerItems[i].classList.add("highlight-wrong");
                }

                if (gameState.aiOrder[i] === gameState.correctOrder[i]) {
                    aiItems[i].classList.add("highlight-correct");
                    aiRoundScore++;
                } else {
                    aiItems[i].classList.add("highlight-wrong");
                }
            }

            gameState.playerScore += playerRoundScore;
            gameState.aiScore += aiRoundScore;
            updateUI();

            displayRoundResults(playerRoundScore, aiRoundScore);
            checkAchievements(playerRoundScore);

            if (gameState.round < gameState.maxRounds) {
                setTimeout(() => {
                    gameState.round++;
                    updateUI();
                    startRound(); // ‚úÖ T·ª∞ ƒê·ªòNG LOOP V√ÅN
                }, 3000);
            } else {
                setTimeout(showFinalResults, 3500);
            }
        }

        function displayRoundResults(playerRound, aiRound) {
            elements.result.style.display = "block"; /* Hi·ªÉn th·ªã l√†m header */
            const correctBoard = createBoardHTML(gameState.correctOrder, true);
            elements.result.innerHTML = `
                <div style="margin: 25px 0;">
                    <div class="label">‚úÖ Th·ª© t·ª± ƒê√öNG:</div>
                    ${correctBoard}
                </div>
                ${playerRound === gameState.numImages ? '<p style="color:#22c55e;font-size:1.5em;">‚≠ê HO√ÄN H·∫¢O!</p>' : ''}
                ${gameState.round < gameState.maxRounds ? '<p style="color:#374151;">‚è≥ 3 gi√¢y n·ªØa ‚Üí V√°n ${gameState.round + 1}</p>' : ''}
            `;
        }

        function showFinalResults() {
            const totalPlayer = gameState.playerScore;
            const totalAI = gameState.aiScore;
            const resultColor = totalPlayer > totalAI ? "#22c55e" : totalPlayer === totalAI ? "#f59e0b" : "#ef4444";

            const title = totalPlayer > totalAI ? "üéâ B·∫†N TH·∫ÆNG!" : totalPlayer === totalAI ? "ü§ù H√íA!" : "ü§ñ AI TH·∫ÆNG!";
            const message = totalPlayer > totalAI ? "Ch√∫c m·ª´ng Ng∆∞·ªùi ch∆°i ƒë√£ th·∫Øng!" : totalPlayer === totalAI ? "K·∫øt qu·∫£ h√≤a!" : "H√£y c·ªë g·∫Øng l·∫ßn sau!";

            if (totalPlayer > totalAI) {
                achievementsUnlocked.push("gameWin");
            }

            let achievementsHTML = '';
            if (achievementsUnlocked.length > 0) {
                const achievements = {
                    firstWin: { title: "üöÄ Kh·ªüi ƒë·∫ßu ho√†n h·∫£o!", desc: `${gameState.numImages}/${gameState.numImages} v√°n ƒë·∫ßu!` },
                    perfectRound: { title: "‚≠ê Ho√†n h·∫£o!", desc: `${gameState.numImages}/${gameState.numImages} ƒë√∫ng th·ª© t·ª±!` },
                    gameWin: { title: "üèÜ B·∫°n Th·∫Øng Cu·ªôc!", desc: "B·∫°n ƒë√£ ƒë√°nh b·∫°i AI m·ªôt c√°ch xu·∫•t s·∫Øc!" }
                };
                achievementsHTML = '<div><h3>Th√†nh t·ª±u m·ªü kh√≥a:</h3><ul>';
                achievementsUnlocked.forEach(key => {
                    const ach = achievements[key];
                    achievementsHTML += `<li><strong>${ach.title}</strong>: ${ach.desc}</li>`;
                });
                achievementsHTML += '</ul></div>';
            }

            document.getElementById("achievement-title").textContent = title;
            document.getElementById("achievement-desc").innerHTML = `${message}<br><br><div class="stats-grid"><div class="stat-box"><p class="stat-number">${totalPlayer}</p><p>ƒêi·ªÉm Ng∆∞·ªùi Ch∆°i</p></div><div class="stat-box"><p class="stat-number">${totalAI}</p><p>ƒêi·ªÉm AI</p></div></div>${achievementsHTML}`;
            document.getElementById("modal-button").textContent = "üî• CH∆†I L·∫†I";
            document.getElementById("modal-button").onclick = () => location.reload();
            document.getElementById("achievement-modal").style.display = "block";
            document.body.classList.add('modal-open');
            launchFireworks();
            fireworksInterval = setInterval(launchFireworks, 1000);
        }

        function launchFireworks() {
            const container = document.querySelector('.fireworks-container');
            if (!container) return;
            container.innerHTML = ''; // Clear previous particles
            const colors = ['red', 'green', 'blue', 'yellow', 'purple', 'cyan', 'orange', 'pink'];
            const numParticles = 30 + Math.floor(Math.random() * 20);
            const explosionX = Math.random() * 80 + 10 + '%';
            const explosionY = Math.random() * 40 + 10 + '%';
            for (let i = 0; i < numParticles; i++) {
                const particle = document.createElement('div');
                particle.classList.add('particle');
                particle.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                particle.style.left = explosionX;
                particle.style.top = explosionY;
                const angle = Math.random() * 2 * Math.PI;
                const speed = Math.random() * 150 + 50;
                const dx = Math.cos(angle) * speed;
                const dy = Math.sin(angle) * speed;
                particle.style.setProperty('--dx', dx + 'px');
                particle.style.setProperty('--dy', dy + 'px');
                container.appendChild(particle);
                setTimeout(() => {
                    particle.remove();
                }, 1100);
            }
        }

        function checkAchievements(playerRound) {
            if (gameState.round === 1 && playerRound === gameState.numImages) achievementsUnlocked.push("firstWin");
            if (playerRound === gameState.numImages) achievementsUnlocked.push("perfectRound");
        }

        function closeModal() {
            clearInterval(fireworksInterval);
            document.getElementById("achievement-modal").style.display = "none";
            document.body.classList.remove('modal-open');
        }

        // ‚úÖ UTILS
        function shuffle(array) {
            return [...array].sort(() => Math.random() - 0.5);
        }

        function createBoardHTML(order, correct = false) {
            const board = document.createElement("div");
            board.className = "board";
            order.forEach(img => {
                const div = createImageBox(img);
                if (correct) div.classList.add("highlight-correct");
                board.appendChild(div);
            });
            return board.outerHTML;
        }

        function updateUI() {
            // B·ªè update header v√¨ ƒë√£ b·ªè
        }

        // ‚úÖ GLOBAL FUNCTIONS
        window.startRound = startRound;
        window.closeModal = closeModal;
    </script>
</body>

</html>